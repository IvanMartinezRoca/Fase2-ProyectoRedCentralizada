# El fichero csv usado tiene estos campos/columnas
$csvPath = "Ruta\al\archivo.csv"
$domain = "dc=IESMiralcamp,dc=mylocal"

# Verificar si se tiene cargado el módulo Active Directory
if (!(Get-Module -Name ActiveDirectory)) {
  Import-Module ActiveDirectory
}

# Creación de los usuarios
$users = Import-Csv -Path $csvPath -Delimiter "$"

foreach ($user in $users) {
    $passAccount = ConvertTo-SecureString $user.Password -AsPlainText -Force
    $Surnames = $user.Surname + " " + $user.Surname1 + " " + $user.Surname2
    $nameLarge = $user.Name + " " + $user.Surname + " " + $user.Surname1
    $email = $user.email
    [boolean]$Habilitado = $true
    If ($user.Enabled -eq "S") { $Habilitado = $false }

    # Establecer los días de expiración de la cuenta
    $ExpirationAccount = [int]$user.TurnPassDays
    $timeExp = (Get-Date).AddDays($ExpirationAccount)

    # Ejecutar el comando para crear el usuario
    New-ADUser -SamAccountName $user.account -UserPrincipalName $user.account -Name $user.account `
        -Surname $Surnames -DisplayName $nameLarge -GivenName $user.Name `
        -Description "Cuenta de $nameLarge" -EmailAddress $email `
        -AccountPassword $passAccount -Enabled $Habilitado `
        -CannotChangePassword $false -ChangePasswordAtLogon $true `
        -PasswordNotRequired $false -Path $user.path -AccountExpirationDate $timeExp
        -LogonWorkstations $user.Computer

    # Establecer horario de inicio de sesión
    $horasSesion = $user.NetTime -replace " ", ""
    net user $user.account /times:$horasSesion

    # Asignar cuenta de Usuario a Grupo
    # Distingued Name CN=Nombre-grupo,ou=..,ou=..,dc=..,dc=...
    $cnGrpAccount = "CN=" + $user.Group + "," + $user.path
    Add-ADGroupMember -Identity $cnGrpAccount -Members $user.account
}

Write-Host "Se han creado los usuarios correctamente en el dominio $domain"
